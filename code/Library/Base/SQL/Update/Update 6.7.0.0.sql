/* UPDATE 6.7.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '6.7.0.0' WHERE "NAME" = 'STORE_DB_VERSION';

SET SEARCH_PATH = "0001";

UPDATE "Gasto" SET "SERIAL" = G."NROW", "CODIGO" = trim(to_char(G."NROW", '00000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA" ) AS "NROW"
     FROM "Gasto" 
     WHERE "FECHA" >= '2013-01-01 00:00:00' AND "SERIAL" != 0) AS G
WHERE "Gasto"."OID" = G."OID";

UPDATE "Gasto" SET "SERIAL" = G."NROW", "CODIGO" = trim(to_char(G."NROW", '00000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA" ) AS "NROW"
     FROM "Gasto" 
     WHERE "FECHA" between '2012-01-01 00:00:00' and '2012-12-31 23:59:59' AND "SERIAL" != 0) AS G
WHERE "Gasto"."OID" = G."OID";

UPDATE "Gasto" SET "SERIAL" = G."NROW", "CODIGO" = trim(to_char(G."NROW", '00000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA" ) AS "NROW"
     FROM "Gasto" 
     WHERE "FECHA" between '2011-01-01 00:00:00' and '2011-12-31 23:59:59' AND "SERIAL" != 0) AS G
WHERE "Gasto"."OID" = G."OID";

/*DELETE FROM "Gasto" 
WHERE "OID_CONCEPTO_FACTURA" > 0 
	AND "OID_CONCEPTO_FACTURA" NOT IN (SELECT "OID" FROM "ConceptoFacturaProveedor");*/
	
UPDATE "Pago" SET "OID_AGENTE" = PG."OID_EMPLEADO"
FROM (	SELECT DISTINCT PG."OID", NM."OID_EMPLEADO"
	FROM "Pago" AS PG
	INNER JOIN (	SELECT "OID_PAGO", COUNT("OID_PAGO") AS "PAGOS"
					FROM (	SELECT PO."OID_PAGO"
							, NM."OID_EMPLEADO"
						FROM "Pago_Operacion" AS PO 
						INNER JOIN "Pago" AS PG ON PG."OID" = PO."OID_PAGO"
						INNER JOIN "Nomina" AS NM ON NM."OID" = PO."OID_OPERACION"
						WHERE PG."TIPO" = 3
						GROUP BY PO."OID_PAGO",NM."OID_EMPLEADO"
						ORDER BY PO."OID_PAGO", NM."OID_EMPLEADO") AS C
					GROUP BY "OID_PAGO")
		AS CP ON CP."OID_PAGO" = PG."OID"
	INNER JOIN "Pago_Operacion" AS PO ON PO."OID_PAGO" = PG."OID"
	INNER JOIN "Nomina" AS NM ON NM."OID" = PO."OID_OPERACION"
	WHERE PG."TIPO" = 3 AND CP."PAGOS" = 1) AS PG
WHERE "Pago"."OID" = PG."OID"