/* UPDATE 7.5.0.1*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '7.5.0.1' WHERE "NAME" = 'STORE_DB_VERSION';

SET SEARCH_PATH = "0001";

CREATE OR REPLACE FUNCTION RenombraPartidas() RETURNS SETOF bigint AS
$BODY$
DECLARE
    r bigint;
BEGIN
	FOR r IN (	SELECT DISTINCT EX."OID" AS "OID_EXPEDIENTE"
					FROM "LineaLibroGanadero" AS LL
					INNER JOIN "Partida" AS PA ON PA."OID" = LL."OID_PARTIDA" 
					INNER JOIN "Expediente" AS EX ON EX."OID" = PA."OID_EXPEDIENTE" 
					WHERE (LL."FECHA" BETWEEN '01/01/0001 00:00:00' AND '12/31/9999 23:59:59') AND LL."OID_LIBRO" = 1 AND LL."TIPO" = 1  
					ORDER BY "OID_EXPEDIENTE")
					
	LOOP
		UPDATE "Partida" SET "SERIAL" = LL."NROW", "CODIGO" = trim(to_char(LL."NROW", '00000'))
		FROM (	SELECT ROW_NUMBER() OVER (ORDER BY "OID_EXPEDIENTE", LL."FECHA" ) AS "NROW"
				,LL."OID_PARTIDA" AS "OID"
				,EX."OID" AS "OID_EXPEDIENTE"
				,PA."SERIAL" AS "SERIAL_PARTIDA"
				,PA."CODIGO" AS "ID_PARTIDA"
				,LL."FECHA"
			FROM "LineaLibroGanadero" AS LL
			INNER JOIN "Partida" AS PA ON PA."OID" = LL."OID_PARTIDA" 
			INNER JOIN "Expediente" AS EX ON EX."OID" = PA."OID_EXPEDIENTE" 
			WHERE (LL."FECHA" BETWEEN '01/01/0001 00:00:00' AND '12/31/9999 23:59:59') AND LL."OID_LIBRO" = 1 
				AND LL."TIPO" = 1 AND EX."OID" = r) AS LL
		WHERE "Partida"."OID" = LL."OID";
		RETURN NEXT r;
	END LOOP;
	RETURN;
END
$BODY$
LANGUAGE 'plpgsql' ;

SELECT * FROM RenombraPartidas();
	
	