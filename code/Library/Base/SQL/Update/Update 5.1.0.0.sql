/* UPDATE 5.1.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '5.1.0.0' WHERE "NAME" = 'STORE_DB_VERSION';

SET SEARCH_PATH = "0001";

DROP TABLE  IF EXISTS "Almacen" CASCADE;
CREATE TABLE "Almacen" 
( 
	"OID" bigserial  NOT NULL,
	"NOMBRE" varchar(255),
	"UBICACION" varchar(255),
	"OBSERVACIONES" text,
	CONSTRAINT "PK_Almacen" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "Almacen" ADD COLUMN "SERIAL" bigint;	
ALTER TABLE "Almacen" ADD COLUMN "CODIGO" varchar(255);
ALTER TABLE "Almacen" ADD COLUMN "ESTADO" int8 DEFAULT 10;

INSERT INTO "Almacen" ("OID", "SERIAL", "CODIGO", "NOMBRE", "ESTADO") VALUES (1, 1, '01', 'ALMACEN CENTRAL', 10);

ALTER TABLE "Producto" ADD COLUMN "ESTADO" bigint DEFAULT 10;
ALTER TABLE "Producto" ADD COLUMN "KILOS_BULTO" numeric(10,2) DEFAULT 1;
ALTER TABLE "Producto" ADD COLUMN "STOCK_MINIMO" numeric(10,2) DEFAULT 0;
ALTER TABLE "Producto" ADD COLUMN "TIPO_VENTA" bigint DEFAULT 10;
ALTER TABLE "Producto" ADD COLUMN "AVISAR_STOCK" boolean DEFAULT TRUE;
ALTER TABLE "Producto" ADD COLUMN "BENEFICIO_CERO" boolean DEFAULT FALSE;

UPDATE "Producto" SET "TIPO_VENTA" = 3 WHERE "UNITARIO" = TRUE;
UPDATE "Producto" SET "TIPO_VENTA" = 2 WHERE "UNITARIO" = FALSE;
UPDATE "Producto" SET "ESTADO" = 10;
UPDATE "Producto" SET "KILOS_BULTO" = 1;

DROP TABLE  IF EXISTS "LineaPedidoProveedor" CASCADE;
CREATE TABLE "LineaPedidoProveedor" 
( 
	"OID" bigserial  NOT NULL,
	"OID_PEDIDO" int8 NOT NULL,
	"OID_PRODUCTO" int8 NOT NULL,
	"OID_PARTIDA" bigint DEFAULT 0,
	"OID_EXPEDIENTE" bigint DEFAULT 0,
	"OID_KIT" bigint DEFAULT 0,
	"FACTURACION_BULTOS" boolean DEFAULT FALSE,
	"P_IMPUESTOS" numeric(10,2) DEFAULT 0,
	"P_DESCUENTO" numeric(10,2) DEFAULT 0,
	"GASTOS" numeric(10,2) DEFAULT 0,
	"ESTADO" int8,
	"CONCEPTO" varchar(255),
	"CANTIDAD" numeric(10,2) NOT NULL DEFAULT 0,
	"CANTIDAD_BULTOS" numeric(10,4),
	"PRECIO" numeric(10,5),
	"SUBTOTAL" numeric(10,2),	
	"TOTAL" numeric(10,2),
	"OBSERVACIONES" text,
	CONSTRAINT "PK_LineaPedidoProveedor" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "LineaPedidoProveedor" OWNER TO moladmin;
GRANT ALL ON TABLE "LineaPedidoProveedor" TO GROUP "MOLEQULE_ADMINISTRATOR";

ALTER TABLE "LineaPedidoProveedor" ADD CONSTRAINT "FK_LineaPedidoProveedor_PedidoProveedor" FOREIGN KEY ("OID_PEDIDO") REFERENCES "PedidoProveedor" ("OID") ON UPDATE CASCADE ON DELETE RESTRICT;
ALTER TABLE "LineaPedidoProveedor" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 0;
ALTER TABLE "LineaPedidoProveedor" ADD COLUMN "OID_IMPUESTO" bigint DEFAULT 0;
ALTER TABLE "LineaPedidoProveedor" ADD COLUMN "CODIGO_PRODUCTO_PROVEEDOR" varchar(255);

ALTER TABLE "PedidoProveedor" ADD COLUMN "OID_SERIE" bigint DEFAULT 0;
ALTER TABLE "PedidoProveedor" ADD COLUMN "P_DESCUENTO" numeric(10,2);
ALTER TABLE "PedidoProveedor" ADD COLUMN "DESCUENTO" numeric(10,2) default 0;
ALTER TABLE "PedidoProveedor" ADD COLUMN "BASE_IMPONIBLE" numeric(10,2);
ALTER TABLE "PedidoProveedor" ADD COLUMN "IMPUESTOS" numeric(10,2);
ALTER TABLE "PedidoProveedor" ADD COLUMN "TOTAL" numeric(10,2);
ALTER TABLE "PedidoProveedor" ADD COLUMN "OID_EXPEDIENTE" bigint DEFAULT 0;
ALTER TABLE "PedidoProveedor" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 0;

ALTER TABLE "Producto_Expediente" RENAME TO "Partida";
ALTER TABLE "Partida" DROP CONSTRAINT "FK_Expediente_Producto_Expediente";
ALTER TABLE "Partida" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 1;

UPDATE "Partida" SET "OID_ALMACEN" = 1;

ALTER TABLE "Partida" ADD CONSTRAINT "FK_Partida_Almacen" FOREIGN KEY ("OID_ALMACEN") REFERENCES "Almacen" ("OID") ON UPDATE CASCADE ON DELETE RESTRICT;

ALTER TABLE "Stock" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 0;

UPDATE "Stock" SET "OID_ALMACEN" = 1;

ALTER TABLE "Stock" DROP CONSTRAINT "FK_Stock_Expediente";
ALTER TABLE "Stock" ADD CONSTRAINT "FK_Stock_Almacen" FOREIGN KEY ("OID_ALMACEN") REFERENCES "Almacen" ("OID") ON UPDATE CASCADE ON DELETE RESTRICT;

ALTER TABLE "ConceptoAlbaranProveedor" ADD COLUMN "OID_LINEA_PEDIDO" bigint DEFAULT 0;
ALTER TABLE "ConceptoAlbaranProveedor" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 0;
ALTER TABLE "ConceptoAlbaranProveedor" ADD COLUMN "CODIGO_PRODUCTO_PROVEEDOR" varchar(255);

UPDATE "ConceptoAlbaranProveedor" SET "OID_ALMACEN" = 1;

ALTER TABLE "AlbaranProveedor" ADD COLUMN "OID_ALMACEN" bigint DEFAULT 0;
ALTER TABLE "AlbaranProveedor" ADD COLUMN "OID_EXPEDIENTE" bigint DEFAULT 0;
ALTER TABLE "AlbaranProveedor" ADD COLUMN "OID_USUARIO" bigint DEFAULT 0;

ALTER TABLE "FacturaProveedor" ADD COLUMN "OID_USUARIO" bigint DEFAULT 0;
ALTER TABLE "FacturaProveedor" ADD COLUMN "OID_EXPEDIENTE" bigint DEFAULT 0;

ALTER TABLE "Expediente" ADD COLUMN "FECHA" timestamp without time zone;

UPDATE "Expediente" SET "SERIAL_ALIMENTACION" = "SERIAL_GANADO" WHERE "TIPO_EXPEDIENTE" = 4;
UPDATE "Expediente" SET "SERIAL_ALIMENTACION" = "SERIAL_MAQUINARIA" WHERE "TIPO_EXPEDIENTE" = 3;

ALTER TABLE "Expediente" RENAME COLUMN "SERIAL_ALIMENTACION" TO "SERIAL";
ALTER TABLE "Expediente" DROP COLUMN "SERIAL_MAQUINARIA";
ALTER TABLE "Expediente" DROP COLUMN "SERIAL_GANADO";

ALTER TABLE "Gasto" ADD COLUMN "OID_ALBARAN" bigint DEFAULT 0;
ALTER TABLE "Gasto" ADD COLUMN "OID_CONCEPTO_FACTURA" bigint DEFAULT 0;
ALTER TABLE "Gasto" ADD COLUMN "OID_CONCEPTO_ALBARAN" bigint DEFAULT 0;

ALTER TABLE "Producto_Proveedor" ADD COLUMN "CODIGO_PRODUCTO_ACREEDOR" varchar(255);
ALTER TABLE "Producto_Proveedor" ADD COLUMN "P_DESCUENTO" numeric(10,2) DEFAULT 0;
ALTER TABLE "Producto_Proveedor" ADD COLUMN "TIPO_DESCUENTO" bigint DEFAULT 1;

--ALTER TABLE "PedidoProveedor" ADD COLUMN "OID_USUARIO" bigint DEFAULT 0;
--ALTER TABLE "PedidoProveedor" ADD COLUMN "OID_ACREEDOR" bigint DEFAULT 0;
--ALTER TABLE "PedidoProveedor" ADD COLUMN "TIPO_ACREEDOR" bigint DEFAULT 1;

ALTER TABLE "Partida" ADD COLUMN "AYUDA" boolean DEFAULT TRUE;
UPDATE "Partida" SET "AYUDA" = TRUE WHERE "OID_EXPEDIENTE" IN (SELECT "OID" FROM "Expediente" WHERE "AYUDA" = TRUE);

--ALTER TABLE "Producto" ADD COLUMN "BENEFICIO_CERO" boolean DEFAULT FALSE;

/*SELECT	
	GT."OID"
	,GT."TOTAL" AS "TOTAL_GASTO"
	,CFP."SUBTOTAL" - (CFP."SUBTOTAL" * CFP."P_DESCUENTO" / 100) AS "TOTAL_CONCEPTO"
	,FP."BASE_IMPONIBLE" AS "BASE_FACTURA"	
	,EX."OID"
	,EX."CODIGO"
	,FP."OID"
	,AP."OID"
	,CFP."OID"
	,CAP."OID"
	,GT."TIPO"
	,CFP."CONCEPTO"
	,FP."FECHA"
	,GT."PREVISION_PAGO"

FROM "Gasto" AS GT
INNER JOIN "Expediente" AS EX ON EX."OID" = GT."OID_EXPEDIENTE"
INNER JOIN "FacturaProveedor" AS FP ON FP."OID" = GT."OID_FACTURA"
INNER JOIN "ConceptoFacturaProveedor" AS CFP ON CFP."OID_FACTURA" = FP."OID" AND (CFP."SUBTOTAL" - (CFP."SUBTOTAL" * CFP."P_DESCUENTO" / 100)) = GT."TOTAL"
INNER JOIN "ConceptoAlbaranProveedor" AS CAP ON CAP."OID" = CFP."OID_CONCEPTO_ALBARAN"  
INNER JOIN "AlbaranProveedor" AS AP ON AP."OID" = CAP."OID_ALBARAN" 
WHERE GT."TIPO" IN(1,3) AND GT."TOTAL" != FP."BASE_IMPONIBLE"
ORDER BY GT."OID";

INSERT INTO "Gasto" ("OID_EXPEDIENTE", "OID_FACTURA", "OID_ALBARAN", "OID_CONCEPTO_FACTURA", "OID_CONCEPTO_ALBARAN", "TIPO", "DESCRIPCION", "TOTAL", "FECHA", "PREVISION_PAGO")
SELECT	
	EX."OID"
	,FP."OID"
	,AP."OID"
	,CFP."OID"
	,CAP."OID"
	,GT."TIPO"
	,CFP."CONCEPTO"
	,CFP."TOTAL"
	,FP."FECHA"
	,GT."PREVISION_PAGO"
FROM "Gasto" AS GT
INNER JOIN "Expediente" AS EX ON EX."OID" = GT."OID_EXPEDIENTE"
INNER JOIN "FacturaProveedor" AS FP ON FP."OID" = GT."OID_FACTURA"
INNER JOIN "ConceptoFacturaProveedor" AS CFP ON CFP."OID_FACTURA" = FP."OID"
INNER JOIN "ConceptoAlbaranProveedor" AS CAP ON CAP."OID" = CFP."OID_CONCEPTO_ALBARAN"  
INNER JOIN "AlbaranProveedor" AS AP ON AP."OID" = CAP."OID_ALBARAN" 
WHERE GT."TIPO"  IN(1,3) AND GT."TOTAL" = FP."BASE_IMPONIBLE";

INSERT INTO "Gasto" ("OID_EXPEDIENTE", "OID_FACTURA", "OID_ALBARAN", "OID_CONCEPTO_FACTURA", "OID_CONCEPTO_ALBARAN", "TIPO", "DESCRIPCION", "TOTAL", "FECHA", "PREVISION_PAGO")
SELECT	
	EX."OID"
	,FP."OID"
	,AP."OID"
	,CFP."OID"
	,CAP."OID"
	,GT."TIPO"
	,CFP."CONCEPTO"
	,(CFP."SUBTOTAL" - (CFP."SUBTOTAL" * CFP."P_DESCUENTO" / 100))
	,FP."FECHA"
	,FP."PREVISION"
FROM "Gasto" AS GT
INNER JOIN "Expediente" AS EX ON EX."OID" = GT."OID_EXPEDIENTE"
INNER JOIN "FacturaProveedor" AS FP ON FP."OID" = GT."OID_FACTURA"
INNER JOIN "ConceptoFacturaProveedor" AS CFP ON CFP."OID_FACTURA" = FP."OID" AND (CFP."SUBTOTAL" - (CFP."SUBTOTAL" * CFP."P_DESCUENTO" / 100)) < GT."TOTAL"
INNER JOIN "ConceptoAlbaranProveedor" AS CAP ON CAP."OID" = CFP."OID_CONCEPTO_ALBARAN"  
INNER JOIN "AlbaranProveedor" AS AP ON AP."OID" = CAP."OID_ALBARAN" 
WHERE GT."TIPO" IN(1,3) AND GT."TOTAL" != FP."BASE_IMPONIBLE";

--Borramos los gastos base anteriores
DELETE FROM "Gasto" WHERE "OID" IN
	 (SELECT DISTINCT GT."OID"
	FROM "Gasto" AS GT
	INNER JOIN "Expediente" AS EX ON EX."OID" = GT."OID_EXPEDIENTE"
	INNER JOIN "FacturaProveedor" AS FP ON FP."OID" = GT."OID_FACTURA"
	INNER JOIN "ConceptoFacturaProveedor" AS CFP ON CFP."OID_FACTURA" = FP."OID"
	INNER JOIN "ConceptoAlbaranProveedor" AS CAP ON CAP."OID" = CFP."OID_CONCEPTO_ALBARAN"  
	INNER JOIN "AlbaranProveedor" AS AP ON AP."OID" = CAP."OID_ALBARAN" 
	WHERE GT."TIPO" IN(1,3) AND GT."TOTAL" = FP."BASE_IMPONIBLE"
	ORDER BY GT."OID");

--Borramos los gastos de Stock
DELETE FROM "Gasto" WHERE "TIPO" = 2;

UPDATE "Gasto" SET "SERIAL" = C."NROW", "CODIGO" = trim(to_char(C."NROW", '00000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "FECHA") AS "NROW"
     FROM "Gasto" 
     ORDER BY "FECHA") AS C
WHERE "Gasto"."OID" = C."OID";*/