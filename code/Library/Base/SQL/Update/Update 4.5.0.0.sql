/* UPDATE 4.5.0.0*/

SET SEARCH_PATH = "COMMON";

UPDATE "Variable" SET "VALUE" = '4.5.0.0' WHERE "NAME" = 'STORE_DB_VERSION';

DROP TABLE IF EXISTS "GastoTransportista" CASCADE;
DROP TABLE IF EXISTS "CuentaEmpresa" CASCADE;

ALTER TABLE "Despachante" ADD COLUMN "ESTADO" int DEFAULT 10;
ALTER TABLE "Naviera" ADD COLUMN "ESTADO" int DEFAULT 10;
ALTER TABLE "Proveedor" ADD COLUMN "ESTADO" int DEFAULT 10;
ALTER TABLE "Transportista" ADD COLUMN "ESTADO" int DEFAULT 10;

UPDATE "Despachante" SET "ESTADO" = 10;
UPDATE "Naviera" SET "ESTADO" = 10;
UPDATE "Proveedor" SET "ESTADO" = 10;
UPDATE "Transportista" SET "ESTADO" = 10;

SET SEARCH_PATH = "0001";

DROP TABLE IF EXISTS "ExpedienteREA";
CREATE TABLE "ExpedienteREA" 
( 
	"OID" bigserial NOT NULL,
	"OID_EXPEDIENTE" bigint NOT NULL,
	"SERIAL" int8 NOT NULL,
	"CODIGO" varchar(255) UNIQUE,
	"ESTADO" bigint DEFAULT 1,
	"CODIGO_ADUANERO" varchar(255),
	"FECHA" timestamp without time zone,
	"EXPEDIENTE_REA" varchar(255),
	"CERTIFICADO_REA" varchar(255),
	"N_DUA" varchar(255),
	"COBRADO" boolean DEFAULT FALSE,
	"OBSERVACIONES" text,
	CONSTRAINT "PK_ExpedienteREA" PRIMARY KEY ("OID")
) WITHOUT OIDS;

ALTER TABLE "ExpedienteREA" OWNER TO moladmin;
GRANT ALL ON TABLE "ExpedienteREA" TO GROUP "MOLEQULE_ADMINISTRATOR";

ALTER TABLE "ExpedienteREA" ADD CONSTRAINT "FK_ExpedienteREA_Expediente" FOREIGN KEY ("OID_EXPEDIENTE") REFERENCES "Expediente" ("OID") ON UPDATE CASCADE ON DELETE CASCADE;

ALTER TABLE "CobroREA" ADD COLUMN "OID_EXPEDIENTE_REA" bigint;

INSERT INTO "ExpedienteREA" 
(
	"OID_EXPEDIENTE", 
	"SERIAL",
	"FECHA",
	"CODIGO_ADUANERO", 
	"EXPEDIENTE_REA", 
	"CERTIFICADO_REA",
	"N_DUA",
	"COBRADO"
)
(SELECT 
	EX."OID",
	EX."OID",
	EX."FECHA_DESPACHO_DESTINO",
	PT."CODIGO_ADUANERO",
	EX."EXPEDIENTE_REA",
	EX."CERTIFICADO_REA",
	EX."N_DUA",
	FALSE	
FROM "Expediente" AS EX
INNER JOIN (SELECT "OID_EXPEDIENTE", MAX("CODIGO_ADUANERO") AS "CODIGO_ADUANERO"
	    FROM "Producto_Expediente" AS PE
        INNER JOIN "Producto" AS PR ON PR."OID" = PE."OID_PRODUCTO"
	    GROUP BY "OID_EXPEDIENTE")
	AS PT ON PT."OID_EXPEDIENTE" = EX."OID"
WHERE EX."AYUDA" = TRUE	AND EX."OID" != 1 AND EX."TIPO_EXPEDIENTE" IN (2,4));

UPDATE "ExpedienteREA" SET "SERIAL" = C."NROW", "CODIGO" = trim(to_char(C."NROW", '00000'))
FROM (SELECT "OID", ROW_NUMBER() OVER (ORDER BY "OID") AS "NROW"
     FROM "ExpedienteREA" 
     ORDER BY "OID") AS C
WHERE "ExpedienteREA"."OID" = C."OID";

UPDATE "CobroREA" SET "OID_EXPEDIENTE_REA" = ER."OID"
FROM "ExpedienteREA" AS ER
WHERE ER."OID_EXPEDIENTE" = "CobroREA"."OID_EXPEDIENTE";

UPDATE "ExpedienteREA" SET "COBRADO" = TRUE
FROM "CobroREA" AS CR
WHERE CR."OID_EXPEDIENTE_REA" = "ExpedienteREA"."OID";